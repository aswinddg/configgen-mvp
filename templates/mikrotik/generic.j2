# Configuración Modular - Mikrotik
# Generado automáticamente

/system identity
set name={{ system_identity }}

{# --- WAN CONFIGURATION --- #}
{% if wan_enabled == 'Yes' %}
/interface ethernet set [ find default-name={{ wan_interface }} ] comment="WAN Interface"

{% if wan_type == 'DHCP' %}
/ip dhcp-client
add comment="WAN DHCP Client" interface={{ wan_interface }} disabled=no
{% elif wan_type == 'Static' %}
/ip address
add address={{ wan_ip }}/{{ wan_mask }} interface={{ wan_interface }} comment="WAN Static IP"

/ip route
add dst-address=0.0.0.0/0 gateway={{ gateway }} comment="Default Route"
{% endif %}
{% endif %}

{# --- LAN CONFIGURATION --- #}
{% if lan_enabled == 'Yes' %}
{% if lan_type == 'Bridge' %}
/interface bridge
add name="{{ lan_interface_name }}" comment="LAN Bridge"

{% if bridge_ports is defined and bridge_ports %}
/interface bridge port
{% for port in bridge_ports.split(',') %}
add bridge="{{ lan_interface_name }}" interface={{ port.strip() }}
{% endfor %}
{% endif %}
{% endif %}

/ip address
add address={{ lan_ip }}/{{ lan_mask }} interface="{{ lan_interface_name }}" network={{ lan_network }}
{% endif %}

{# --- DHCP SERVER --- #}
{% if dhcp_server_enabled == 'Yes' %}
/ip pool
add name=dhcp_pool_lan ranges={{ dhcp_pool_start }}-{{ dhcp_pool_end }}

/ip dhcp-server
add address-pool=dhcp_pool_lan interface="{{ lan_interface_name }}" lease-time={{ dhcp_lease_time }} name=dhcp_server_lan disabled=no

/ip dhcp-server network
add address={{ lan_network }}/{{ lan_mask }} gateway={{ lan_ip }} {% if dns_servers %}dns-server={{ dns_servers }}{% endif %}
{% endif %}

{# --- NAT CONFIGURATION --- #}
{% if wan_enabled == 'Yes' and enable_nat == 'Yes' %}
/ip firewall nat
add action=masquerade chain=srcnat out-interface={{ nat_outside if nat_outside is defined and nat_outside else wan_interface }}
{% endif %}

{# --- BASIC FIREWALL --- #}
/ip firewall filter
add chain=input action=accept connection-state=established,related comment="Accept established/related"
add chain=input action=accept src-address={{ lan_network }}/{{ lan_mask }} comment="Accept from LAN"
add chain=input action=drop comment="Drop all other input"

add chain=forward action=accept connection-state=established,related comment="Accept established/related"
add chain=forward action=accept src-address={{ lan_network }}/{{ lan_mask }} comment="Accept from LAN"
add chain=forward action=drop comment="Drop all other forward"
